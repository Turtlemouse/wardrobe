{% extends "layout.html" %}
{% block content %}

<h2>
    {% if issue %} Edit Issue {% else %} Add New Issue {% endif %}
</h2>

<form method="POST"
      action="{% if issue %}/issues/{{ issue.issue_id }}/edit{% else %}/issues/new{% endif %}"
      class="mt-4">

    <!-- Diagnosis Foreign Key (Searchable Dropdown) -->
    <div class="mb-3">
        <label class="form-label">Diagnosis *</label>
        <select id="diagnosis_select" name="diagnosis_id" class="form-select" required>
            <option value="">-- Select Diagnosis --</option>
            {% for diagnosis in diagnoses %}
            <option value="{{ diagnosis.diagnosis_id }}"
                {% if issue and issue.diagnosis_id == diagnosis.diagnosis_id %}selected{% endif %}>
                {{ diagnosis.diagnosis }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Date -->
    <div class="mb-3">
        <label class="form-label">Date *</label>
        <input name="date" type="date" class="form-control"
               value="{{ issue.date if issue else '' }}" required>
    </div>

    <!-- Student Foreign Key (Searchable Dropdown) -->
    <div class="mb-3">
        <label class="form-label">Student *</label>
        <select id="student_select" name="student_id" class="form-select" required>
            <option value="">-- Select Student --</option>
            {% for student in students %}
            <option value="{{ student.student_id }}"
                {% if issue and issue.student_id == student.student_id %}selected{% endif %}>
                {{ student.name }} ({{ student.email }})
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Provider Foreign Key (Searchable Dropdown) - Optional -->
    <div class="mb-3">
        <label class="form-label">Healthcare Provider</label>
        <select id="provider_select" name="provider_id" class="form-select">
            <option value="">-- Select Provider (Optional) --</option>
            {% for provider in providers %}
            <option value="{{ provider.provider_id }}"
                {% if issue and issue.provider_id == provider.provider_id %}selected{% endif %}>
                {{ provider.name }} ({{ provider.specialization if provider.specialization else 'General' }})
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Counselor Foreign Key (Searchable Dropdown) - Optional -->
    <div class="mb-3">
        <label class="form-label">Counselor</label>
        <select id="counselor_select" name="counselor_id" class="form-select">
            <option value="">-- Select Counselor (Optional) --</option>
            {% for counselor in counselors %}
            <option value="{{ counselor.counselor_id }}"
                {% if issue and issue.counselor_id == counselor.counselor_id %}selected{% endif %}>
                {{ counselor.name }} ({{ counselor.specialization }})
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Visit Foreign Key (Searchable Dropdown) - Optional -->
    <div class="mb-3">
        <label class="form-label">Visit</label>
        <select id="visit_select" name="visit_id" class="form-select">
            <option value="">-- Select Visit (Optional) --</option>
            {% for visit in visits %}
            <option value="{{ visit.visit_id }}"
                {% if issue and issue.visit_id == visit.visit_id %}selected{% endif %}>
                Visit #{{ visit.visit_id }} - {{ visit.date }} ({{ visit.student_name }})
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Comments -->
    <div class="mb-3">
        <label class="form-label">Comments</label>
        <textarea name="comments" class="form-control" rows="4">{{ issue.comments if issue else '' }}</textarea>
    </div>

    <!-- Select2 Initialization -->
    <script>
    $(document).ready(function() {
        $('#diagnosis_select').select2({
            placeholder: "Select or search a diagnosis...",
            allowClear: true,
            width: '100%'
        });
        
        $('#student_select').select2({
            placeholder: "Select or search a student...",
            allowClear: true,
            width: '100%'
        });
        
        $('#provider_select').select2({
            placeholder: "Select or search a provider...",
            allowClear: true,
            width: '100%'
        });
        
        $('#counselor_select').select2({
            placeholder: "Select or search a counselor...",
            allowClear: true,
            width: '100%'
        });
        
        $('#visit_select').select2({
            placeholder: "Select or search a visit...",
            allowClear: true,
            width: '100%'
        });
    });
    </script>

    <button class="btn btn-success">
        {% if issue %} Save Changes {% else %} Add Issue {% endif %}
    </button>

    <a href="/issues" class="btn btn-secondary">Cancel</a>
</form>

{% endblock %}